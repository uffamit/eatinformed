name: CI Checks

# Run this workflow on push to main and on pull requests targeting main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job to check for accidentally committed .env files
  env_check:
    name: Check for .env files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check if .env files are committed
        run: |
          # Check if any file starting with .env exists
          if ls .env* 1> /dev/null 2>&1; then
            echo "Error: A .env file was found in the repository!"
            echo "Please remove it and ensure '.env*' is in your .gitignore file."
            exit 1
          else
            echo ".env files are correctly ignored and not present."
            exit 0
          fi

  # Job to run ESLint
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    needs: env_check # Run after env_check
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Based on your @types/node dependency
          cache: 'yarn'      # Your project uses yarn
      
      - name: Install dependencies
        # Use --frozen-lockfile for CI to ensure exact dependencies
        run: yarn install --frozen-lockfile
      
      - name: Run linter
        run: yarn lint

  # Job to run TypeScript type checking
  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    needs: env_check
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Run type check
        run: yarn typecheck

  # Job to run the production build
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, typecheck] # Run after lint and typecheck pass
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Run build
        run: yarn build

  # Job for Unit Tests, as you requested
  tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build # Run after build passes
    steps:
      - uses: actions/checkout@v4
      # You may need to add Node.js setup and yarn install here
      # if your tests run separately from the build
      
      - name: Run tests
        run: |
          echo "Warning: No 'test' script found in package.json."
          echo "To run tests, please add a 'test' script to your package.json."
          # We exit 0 so this check passes but still provides a warning
          exit 0
